<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estación Meteorológica ETec</title>

  <link rel="shortcut icon" href="https://i.ibb.co/hctNTsB/logo.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Sharp" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="./frontend/style.css">

  <style>
    :root{
      --bg:        #070b14;
      --card-bg:   #0f172a;
      --surface:   #0b1220;
      --fg:        #e7eef7;
      --muted:     #93a4b8;
      --accent:    #22d3ee;
      --accent-2:  #38bdf8;
      --ring:      rgba(34,211,238,.35);
      --chip-bg:   rgba(148,163,184,.15);
      --shadow:    0 10px 30px rgba(2,6,23,.45);
      --header-h:  0px;
    }
    div {color: var(--color-black);}
    span {color: var(--color-black);}
    html,body{height:100%; background:var(--bg);}
    body{ margin:0; color:var(--fg); font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

    .page-wrap{ width:min(1200px, 92vw); margin-inline:auto; padding: calc(16px + var(--header-h))  min(3vw,28px) 28px; }

    .hero{ display:flex; gap:14px; align-items:flex-start; margin-bottom:18px; }
    .hero__icon{
      display:grid; place-items:center; width:48px; height:48px; border-radius:14px;
      background: radial-gradient(120% 120% at 20% 20%, rgba(34,211,238,.25), rgba(56,189,248,.12) 40%, rgba(2,6,23,.6) 72%);
       box-shadow: 0 6px 20px rgba(2,6,23,.35), inset 0 0 0 1px rgba(255,255,255,.03);
      flex:0 0 auto;
    }
    @media (prefers-color-scheme: light){
  .hero__icon{
    background: radial-gradient(120% 120% at 20% 20%, rgba(14,165,233,.25), rgba(16,185,129,.15) 40%, rgba(255,255,255,.9) 90%);
    border:1px solid rgba(14,165,233,.25);
    box-shadow: 0 4px 12px rgba(2,6,23,.08);
  }}
    .hero__text{flex:1; min-width:0;}
    .hero__title{
      margin:0; font-weight:800; font-size:clamp(1.25rem, 3.2vw, 2rem); line-height:1.08;
      color: var(--color-black); text-shadow:0 1px 0 rgba(0,0,0,.25), 0 8px 24px rgba(0,0,0,.25); letter-spacing:.2px;
    }
    .hero__badge{
      display:inline-flex; align-items:center; gap:.35rem; background: rgba(34,211,238,.12);
      border:1px solid rgba(34,211,238,.35); color: var(--color-black); padding:4px 8px; border-radius:999px; font-size:.78rem; margin-top:.5rem;
    }
    .hero__subtitle{ margin:.55rem 0 0; color:var(--muted); font-size:clamp(.92rem, 1.8vw, 1rem); max-width:72ch; }

    .viajes-grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap:clamp(12px, 2vw, 18px); place-items:center;
    }

    .card{
      width:100%; max-width: 380px; background: linear-gradient(180deg, var(--card-white), var(--surface));
      border:1px solid rgba(148,163,184,.15); border-radius:18px; overflow:hidden; box-shadow:var(--shadow);
      transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
    }
    .card:hover{ transform:translateY(-2px); box-shadow:0 14px 40px rgba(2,6,23,.6); border-color:rgba(56,189,248,.35); }

    .card__media{ position:relative; aspect-ratio: 16/9; overflow:hidden; }
    .card__media img{ width:100%; height:100%; object-fit:cover; object-position:center; display:block; transform:scale(1.02); transition:transform .45s ease; filter:saturate(1.05) contrast(1.04); }
    .card:hover .card__media img{ transform:scale(1.07); }

    .chip{
      position:absolute; left:10px; bottom:10px; background:var(--chip-bg); backdrop-filter:blur(6px);
      color:var(--fg); padding:6px 10px; border-radius:999px; font-size:.78rem; border:1px solid rgba(148,163,184,.2);
      display:flex; align-items:center; gap:.4rem;
    }
    .card__body{ padding:14px 14px 16px; display:flex; flex-direction:column; gap:8px; }
    .card__title{ margin:0; font-size:1.06rem; font-weight:700; letter-spacing:.2px; }
    .card__desc{ color:var(--muted); font-size:.95rem; line-height:1.45; margin:.1rem 0 .2rem; }
    .meta{ display:flex; gap:.65rem; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:.86rem; }
    .meta .dot{ width:6px; height:6px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 4px var(--ring); }

    .card__actions{ display:flex; gap:10px; margin-top:8px; }
    .btn{ appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:600; letter-spacing:.2px; transition:.18s ease; }
    .btn:active{ transform:translateY(1px) scale(.99); }
    .btn-primary{ background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#06202b; box-shadow:0 8px 22px rgba(34,211,238,.25); }
    .btn-primary:hover{ box-shadow:0 10px 28px rgba(56,189,248,.35); }
    .btn-ghost{ background:transparent; color:var(--color-black); border:1px solid rgba(148,163,184,.25); }
    .btn-ghost:hover{ border-color:rgba(56,189,248,.45); color:#e6f9ff; box-shadow:0 8px 22px rgba(34,211,238,.15); }

    @media (max-width:680px){ .hero{align-items:center;} .card__actions{gap:8px;} .btn{padding:9px 12px; border-radius:10px;} }

    .swal2-html-container{ margin:0 !important; }
    .swal2-popup{ width:min(92vw, 920px) !important; }
    #mapa-viaje{ height:min(62vh, 520px); min-height:360px; border-radius:12px; overflow:hidden; }
  </style>
</head>
<body data-active="index">
  <div id="header-placeholder"></div>

  <main class="page-wrap">
    <section class="hero" aria-labelledby="hero-title">
      <div class="hero__icon" aria-hidden="true">
        <span class="material-symbols-sharp">flight_takeoff</span>
      </div>
      <div class="hero__text">
        <h1 id="hero-title" class="hero__title">Estaciones Meteorológicas Móviles ETec UM</h1>
        <span class="hero__badge"><span class="material-symbols-sharp" style="font-size:16px;">map</span> Viajes con datos registrados</span>
        <p class="hero__subtitle">Recorridos de la estación móvil: abrí el dataset o visualizá el mapa con coordenadas y variables de cada punto.</p>
      </div>
    </section>

    <section id="viajes-grid" class="viajes-grid" aria-live="polite"></section>
  </main>

  <script>
    // VIAJES
    const VIAJES = [
      {
        titulo:"Lavalle, Mendoza",
        fecha:"2025-09-05",
        imagen:"https://etec.um.edu.ar/wp-content/uploads/lavalle.png",
        resumen:"Recorrido por zonas vitícolas de Lavalle con registro de T°, HR, viento y ubicación.",
        botonURL:"https://emetec.wetec.um.edu.ar/datoslv",  // <- JSON crudo
        etiqueta:"Muestreo 1",
        mapEndpoint:"https://emetec.wetec.um.edu.ar/datoslavallepp"
      },
    ];

    const grid = document.getElementById('viajes-grid');

    function setHeaderOffset(){
      const hdr = document.querySelector('#header-placeholder > *');
      const h = hdr ? (hdr.offsetHeight || 0) : 0;
      document.documentElement.style.setProperty('--header-h', h + 'px');
    }
    $(function(){
      $("#header-placeholder").load("frontend/header.html", function(_, status){
        if(status!=="error"){ setHeaderOffset(); }
      });
      window.addEventListener('resize', setHeaderOffset);
      setTimeout(setHeaderOffset, 400);
    });

    function fmtFecha(iso){
      try{ return new Date(iso+'T00:00:00').toLocaleDateString('es-AR',{year:'numeric',month:'long',day:'numeric'}); }
      catch{ return iso; }
    }

    function crearCard(v){
      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <div class="card__media">
          <img src="${v.imagen}" alt="Foto del viaje: ${v.titulo}" loading="lazy">
          <span class="chip"><span class="material-symbols-sharp" style="font-size:17px;">pin_drop</span>${v.etiqueta || 'Campaña'}</span>
        </div>
        <div class="card__body">
          <h2 class="card__title">${v.titulo}</h2>
          <div class="meta" aria-label="Metadatos del viaje">
            <span class="material-symbols-sharp" aria-hidden="true" style="font-size:18px;">event</span>
            <span>${fmtFecha(v.fecha)}</span>
            <span class="dot"></span>
            <span>Estación móvil</span>
          </div>
          <p class="card__desc">${v.resumen}</p>
          <div class="card__actions">
            <!-- 1) Ver mapa (PRIMERO) -->
            <button class="btn btn-primary" type="button"
                    data-map-endpoint="${v.mapEndpoint || ''}"
                    data-title="${v.titulo}">
              Ver mapa
            </button>

            <!-- 2) Ver datos crudos (segundo, con aviso) -->
            <button class="btn btn-ghost" type="button"
                    data-raw-url="${v.botonURL || ''}">
              Ver datos crudos
            </button>
          </div>
        </div>`;

      // Botón Mapa
      const mapBtn = card.querySelector('[data-map-endpoint]');
      mapBtn.addEventListener('click', (e)=>{
        const endpoint = e.currentTarget.getAttribute('data-map-endpoint');
        const title = e.currentTarget.getAttribute('data-title') || 'Mapa del viaje';
        if(!endpoint) return Swal.fire({ title:'Mapa no disponible', text:'Este viaje aún no tiene mapa.', icon:'info' });
        abrirMapaDesdeEndpoint(title, endpoint);
      });

      // Botón Datos crudos (alerta + abrir JSON si confirman)
      const rawBtn = card.querySelector('[data-raw-url]');
      rawBtn.addEventListener('click', (e)=>{
        const url = e.currentTarget.getAttribute('data-raw-url');
        if(!url){
          return Swal.fire({ title:'Sin datos crudos', text:'No hay URL configurada para este viaje.', icon:'info' });
        }
        Swal.fire({
          icon: 'warning',
          title: 'Datos crudos: aviso importante',
          html: `
            <p style="text-align:left">
              Estos datos fueron recolectados en una zona remota y pueden <b>no cuadrar exactamente con la realidad</b>
              debido a <b>pérdidas de conexión a Internet</b> durante la captura.
            </p>
            <ul style="text-align:left; margin:.6rem 0 0 1.1rem; line-height:1.35;">
              <li>Registros faltantes o duplicados</li>
              <li>Timestamps desfasados</li>
              <li>Lecturas intermitentes</li>
            </ul>
          `,
          confirmButtonText: 'Abrir de todos modos',
          showCancelButton: true,
          cancelButtonText: 'Cancelar',
          focusConfirm: true
        }).then(res=>{
          if(res.isConfirmed){
            window.open(url, '_blank', 'noopener');
          }
        });
      });

      return card;
    }

    // Render
    (VIAJES.length?VIAJES:[{titulo:'Aún no hay viajes',resumen:'Cuando registremos datos en campo, aparecerán acá.'}])
      .forEach(v=>grid.appendChild(crearCard(v)));

    // ======= MAPA =======
    async function abrirMapaDesdeEndpoint(titulo, urlJson){
      let datos=[];
      try{
        Swal.fire({ title:'Cargando mapa…', html:'<div style="height:20vh;display:flex;align-items:center;justify-content:center;">Obteniendo puntos…</div>', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
        const resp = await fetch(urlJson, { headers:{'Accept':'application/json'} });
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        datos = await resp.json();
      }catch(e){
        console.error(e);
        Swal.close();
        return Swal.fire({ title:'No se pudo cargar', text:'Revisá el endpoint o CORS.', icon:'error' });
      }

      const puntos=[];
      for(const item of datos){
        let lat=null,lng=null;
        if(typeof item.ubicacion==='string'){
          const [a,b]=item.ubicacion.split(',').map(s=>parseFloat(s.trim()));
          if(!isNaN(a)&&!isNaN(b)){lat=a;lng=b;}
        }else if(Array.isArray(item.ubicacion) && item.ubicacion.length>=2){
          lat=parseFloat(item.ubicacion[0]); lng=parseFloat(item.ubicacion[1]);
        }else if(item.lat!=null && item.lng!=null){
          lat=parseFloat(item.lat); lng=parseFloat(item.lng);
        }
        if(isNaN(lat)||isNaN(lng)) continue;
        puntos.push({
          lat,lng,
          hora:item.hora ?? '—',
          temperatura:item.temperatura ?? '—',
          humedad:item.humedad ?? '—',
          presion:item.presion ?? '—',
          altitud:item.altitud ?? '—'
        });
      }
      if(!puntos.length){
        Swal.close();
        return Swal.fire({ title:'Sin coordenadas válidas', text:'El JSON no tiene puntos parseables.', icon:'warning' });
      }

      Swal.fire({
        title: titulo,
        width: 'auto',
        showConfirmButton:true,
        confirmButtonText:'Cerrar',
        html: `
          <div style="display:flex;gap:10px;align-items:stretch;flex-wrap:wrap;">
            <div style="flex:2 1 480px; min-width:280px;">
              <div id="mapa-viaje"></div>
            </div>
            <div style="flex:1 1 260px; min-width:260px; font-size:.92rem; color:#cbd5e1;">
              <div style="background:var(--color-black);border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:10px;">
                <b>Resumen</b>
                <ul style="margin:.5rem 0 0 1.1rem; line-height:1.4;">
                  <li>Puntos: <b>${puntos.length}</b></li>
                  <li>Primera hora: <b>${puntos[0].hora}</b></li>
                  <li>Última hora: <b>${puntos[puntos.length-1].hora}</b></li>
                </ul>
              </div>
              <div style="height:10px;"></div>
              <div style="background:var(--color-black);border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:10px;">
                <b>Leyenda</b>
                <div style="margin-top:.3rem;display:grid;grid-template-columns:auto 1fr;gap:.4rem 1rem;align-items:center;">
                  <span style="width:14px;height:14px;border-radius:50%;background:#3b82f6;display:inline-block;"></span><span>Marcadores</span>
                  <span style="width:20px;height:3px;background:#22d3ee;display:inline-block;"></span><span>Recorrido</span>
                </div>
              </div>
              <div style="background:var(--color-black);border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:10px; margin-top:10px;">
                <b>Tip:</b> Si no se ven los marcadores indicados, hacé zoom y clic en los marcadores para ver variables del punto.
              </div>
            </div>
          </div>
        `,
didOpen: () => {
  const KEY = 'AIzaSyAszjcR7sWSUaFUkhglDDcJehrj4-MB53o';

  const loadScript = (src) => new Promise((res, rej) => {
    const s = document.createElement('script');
    s.src = src; s.async = true; s.defer = true;
    s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });

  const initMap = () => {
    // Proveedores y sus límites típicos
    const MAX_Z = {
      OSM: 19,      // OSM estándar
      ESRI: 19,     // World Imagery
      G: 21         // Google (siempre clamp por si la zona no llega)
    };

    // Mapa con un max por defecto (luego lo ajustamos por capa)
    const map = L.map('mapa-viaje', {
      center: [-32.969924, -68.844069],
      zoom: 12,
      minZoom: 2,
      maxZoom: MAX_Z.G,
      zoomSnap: 0.25,
      wheelDebounceTime: 35,
      preferCanvas: true
    });

    // Bases
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: MAX_Z.OSM, attribution:'© OpenStreetMap'
    });

    const esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: MAX_Z.ESRI, attribution: 'Tiles © Esri' }
    );

    const hasGoogleMutant = !!(L.gridLayer && L.gridLayer.googleMutant && window.google && window.google.maps);
    const googleSat = hasGoogleMutant ? L.gridLayer.googleMutant({ type:'satellite', maxZoom: MAX_Z.G, attribution:'© Google' }) : null;
    const googleHybrid = hasGoogleMutant ? L.gridLayer.googleMutant({ type:'hybrid', maxZoom: MAX_Z.G, attribution:'© Google' }) : null;

    // Base inicial (priorizo Google, si no hay, Esri)
    let currentBase = 'G';
    const startBase = googleSat || esriSat;
    startBase.addTo(map);

    // Control capas
    const baseMaps = {};
    if (googleSat) baseMaps['Satélite (Google)'] = googleSat;
    if (googleHybrid) baseMaps['Híbrido (Google)'] = googleHybrid;
    baseMaps['Satélite (Esri)'] = esriSat;
    baseMaps['Mapa callejero (OSM)'] = osm;

    L.control.layers(baseMaps, null, { collapsed:false }).addTo(map);

    // Función para ajustar maxZoom según base activa
    const applyMaxZoomFor = (baseName) => {
      if (/OSM/i.test(baseName)) { currentBase = 'OSM'; map.setMaxZoom(MAX_Z.OSM); }
      else if (/Esri/i.test(baseName)) { currentBase = 'ESRI'; map.setMaxZoom(MAX_Z.ESRI); }
      else { currentBase = 'G'; map.setMaxZoom(MAX_Z.G); }
      // Si el zoom actual excede el permitido, lo clampo sin animar.
      const maxAllowed = map.getMaxZoom();
      if (map.getZoom() > maxAllowed) map.setZoom(maxAllowed, { animate:false });
    };

    // Al cambiar de base, actualizo límites
    map.on('baselayerchange', (e) => applyMaxZoomFor(e.name));

    // También clamp en cada zoomend por si se forzó con trackpad
    map.on('zoomend', () => {
      const z = map.getZoom(), maxAllowed = map.getMaxZoom();
      if (z > maxAllowed) map.setZoom(maxAllowed, { animate:false });
    });

    // Dibujo de puntos y polyline
    const latlngs = [];
    puntos.forEach((p, i) => {
      const ll = [p.lat, p.lng];
      latlngs.push(ll);
      const popup = `
        <div style="min-width:220px">
          <b>Punto ${i + 1}</b><br>
          Hora: ${p.hora}<br>
          T°: ${p.temperatura} °C<br>
          HR: ${p.humedad} %<br>
          P: ${p.presion} hPa<br>
          Alt: ${p.altitud} m
        </div>`;
      L.circleMarker(ll, {
        radius: 6, weight: 2, color: '#1e293b',
        fillColor: '#3b82f6', fillOpacity: .9
      }).addTo(map).bindPopup(popup);
    });

    if (latlngs.length) {
      L.polyline(latlngs, { color:'#22d3ee', weight:3, opacity:.9 }).addTo(map);
      map.fitBounds(L.latLngBounds(latlngs), { padding:[20,20] });
    }

    L.control.scale({ imperial:false }).addTo(map);

    // Asegurar render en modal
    setTimeout(() => {
      map.invalidateSize();
      // Aplico límite acorde a la base inicial visible
      const initialName = googleSat ? 'Satélite (Google)' : 'Satélite (Esri)';
      applyMaxZoomFor(initialName);
    }, 150);
  };

  // Carga condicional de Google + plugin
  const needsGoogle = !window.google || !window.google.maps;
  const needsMutant = !(L.gridLayer && L.gridLayer.googleMutant);

  const loaders = [];
  if (needsGoogle) loaders.push(loadScript(`https://maps.googleapis.com/maps/api/js?key=${KEY}&loading=async&callback=Function.prototype`));
  if (needsMutant) loaders.push(loadScript('https://unpkg.com/leaflet.gridlayer.googlemutant/Leaflet.GoogleMutant.js'));

  Promise.allSettled(loaders).then(initMap).catch(initMap);
}

      });
    }
  </script>
  <!-- Google Maps JS (tu API key) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAszjcR7sWSUaFUkhglDDcJehrj4-MB53o&callback=Function.prototype"></script>

<!-- Plugin Google Mutant para Leaflet -->
<script src="https://unpkg.com/leaflet.gridlayer.googlemutant/Leaflet.GoogleMutant.js"></script>


  <script src="frontend/front.js"></script>
</body>
</html>